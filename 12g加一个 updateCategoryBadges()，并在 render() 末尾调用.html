<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8">
    <title>ğŸ“‹åˆ†ç±»å¾…åŠäº‹é¡¹</title>

  <style>
    :root{
      --blue:#3498db;
      --blue-d:#2980b9;
      --bg:#f5f7fa;
      --muted:#777;
      --red:#e74c3c;
      --red-d:#c0392b;
      --text:#333;
    }

    *{ box-sizing:border-box; }
    body{
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 0;
      margin: 0;
      background: linear-gradient(135deg, #dbeafe, #fef9c3);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: var(--text);
    }
    /* å¤–å±‚å®¹å™¨ï¼ˆå¡ç‰‡å£³ï¼‰ */
    .container-panel{
      max-width: 840px;
      margin: 0 auto;
      background: #ffffffcc; /* åŠé€æ˜ç™½ï¼Œè¡¬æ‰˜èƒŒæ™¯ */
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      padding: 32px 24px;
      backdrop-filter: blur(10px); /* å¢åŠ è½»å¾®ç»ç’ƒç£¨ç ‚æ•ˆæœ */
    }

    h1 {
      text-align: center;
      font-size: 30px;
      font-weight: 700;
      color: #1e3a8a;
      margin-bottom: 25px;
      letter-spacing: 0.5px;
    }

    /* é¡¶éƒ¨â€œæ·»åŠ ä»»åŠ¡â€è¡Œ */
    .row{ display:flex; gap:8px; flex-wrap:wrap; margin:12px 0 8px; }
    .row input[type="text"]{
      flex:1; min-width:240px; padding:10px 12px; border:1px solid #ddd; border-radius:8px;
    }
    .row select{
      padding:10px 12px; border:1px solid #ddd; border-radius:8px;
    }
    .btn{
      padding:10px 14px; border:0; border-radius:8px; background:var(--blue); color:#fff; cursor:pointer;
      transition:background .2s ease;
    }
    .btn:hover{ background:var(--blue-d); }

    /* åˆ†ç±»ç­›é€‰æŒ‰é’®åŒº */
    #filters{ display:flex; gap:8px; flex-wrap:wrap; margin:12px 0; }
    #filters button{
      padding:8px 12px; border:1px solid #ddd; border-radius:20px; background:#fff; cursor:pointer;
      transition: all .2s ease;
    }
    #filters button:hover{ transform:translateY(-1px); }
    #filters button.is-active{ background:var(--blue); color:#fff; border-color:var(--blue); }

    /* è‡ªå®šä¹‰åˆ†ç±»è¡Œï¼ˆè¾“å…¥ + chipså±•ç¤ºï¼‰ */
    #customCatForm{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0; }
    #customCats{ display:flex; gap:6px; flex-wrap:wrap; margin:6px 0 12px; color:var(--muted); }
    .chip{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:16px; background:#eee;
    }
    .chip .chip-del{
      background:var(--red); color:#fff; border:0; border-radius:12px; padding:2px 8px; cursor:pointer;
    }
    .chip .chip-del:hover{ background:var(--red-d); }

    /* ä»»åŠ¡åˆ—è¡¨å¡ç‰‡åŒ– */
    #taskList{ list-style:none; padding-left:0; margin:14px 0; }
    #taskList li{
      display:flex; align-items:center; gap:10px; padding:12px; margin-bottom:10px;
      background:#f8f9fa; border-radius:10px; border-left:4px solid var(--blue);
      box-shadow: 0 2px 6px rgba(0,0,0,.05); transition: transform .15s ease, box-shadow .15s ease;
    }
    #taskList li:hover{ transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,.08); }

    /* æ–‡æœ¬å®Œæˆæ€ç”¨ç±»åæ§åˆ¶ï¼ˆæ¯”è¡Œå†…æ ·å¼å¹²å‡€ï¼‰ */
    .task-text{ flex:1; word-break: break-word; }
    .task-text.completed{ text-decoration:line-through; color:var(--muted); }

    /* â€”â€” ä»»åŠ¡åˆ é™¤æŒ‰é’®ï¼ˆå±é™©ä¸»é¢˜ï¼‰ â€”â€” */
    .btn-del{
      position: relative;
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border:0;
      border-radius:999px;
      font-size:13px;
      font-weight:600;
      color:#fff;
      background: linear-gradient(#f05b51, #e1473f); /* çº¢è‰²æ¸å˜ */
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, background .2s ease;
      box-shadow: 0 4px 12px rgba(225, 71, 63, .35);
    }
    .btn-del::before{
      content: "ğŸ—‘ï¸";
      font-size:14px;
      line-height:1;
    }
    .btn-del:hover{
      transform: translateY(-1px);
      background: linear-gradient(#f46c62, #e44f46);
      box-shadow: 0 8px 18px rgba(225, 71, 63, .45);
    }
    .btn-del:active{
      transform: translateY(0);
      box-shadow: 0 4px 12px rgba(225, 71, 63, .35);
    }
    .btn-del:focus-visible{
      outline:none;
      box-shadow: 0 0 0 3px rgba(228,79,70,.35);
    }

    /* ç»Ÿè®¡è¡Œ */
    #stats, #statsCurrent{ color:#555; margin:6px 0; }

    /* ç©ºæ€ */
    .empty{ color:var(--muted); text-align:center; padding:24px 8px; }

    /* å“åº”å¼æ”¶æ•› */
    @media (max-width:600px){
      .row{ flex-direction:column; }
    }

    /* â€”â€” åˆ†ç±»ç­›é€‰æŒ‰é’®ï¼ˆå¢å¼ºç‰ˆï¼‰ â€”â€” */
    #filters{
      display:flex; gap:10px; flex-wrap:wrap; margin:14px 0;
    }
    #filters button{
      padding:10px 16px;
      border:1px solid #d7e0ea;
      border-radius:999px;
      background: linear-gradient(#ffffff, #f6f9fc);
      color:#1f2937;
      font-weight:600;
      letter-spacing:.2px;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, background .2s ease, color .2s ease, border-color .2s ease;
      box-shadow: 0 1px 0 rgba(0,0,0,.02), 0 1px 8px rgba(0,0,0,.04) inset;
    }
    #filters button:hover{
      transform: translateY(-1px);
      background: linear-gradient(#ffffff, #eef2f7);
      box-shadow: 0 6px 14px rgba(0,0,0,.08);
    }
    #filters button:active{
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(0,0,0,.08);
    }
    #filters button:focus-visible{
      outline: none;
      box-shadow: 0 0 0 3px rgba(52,152,219,.35);
    }

    /* æ¿€æ´»æ€ï¼šè“è‰²èƒ¶å›Š + æŸ”å…‰ */
    #filters button.is-active{
      color:#fff;
      border-color:#2f82c7;
      background: linear-gradient(#3498db, #2d83c3);
      box-shadow: 0 10px 20px rgba(52,152,219,.35), 0 0 0 1px #2f82c7 inset;
      transform: translateY(-1px);
    }
    #filters button.is-active:hover{
      background: linear-gradient(#4aa7e4, #2f89cb);
    }

    /* è‡ªå®šä¹‰åˆ†ç±»è¾“å…¥åŒºï¼ˆè½»å¡ç‰‡ + å›¾æ ‡æ„Ÿ + ç„¦ç‚¹é«˜äº®ï¼‰ */
    .cat-form{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding:12px 14px; margin:10px 0 4px;
      background:#ffffffcc; border:1px solid #e5e7eb; border-radius:12px;
      box-shadow:0 4px 16px rgba(0,0,0,.05);
      backdrop-filter: blur(6px);
    }
    .cat-input{
      flex:1; min-width:220px;
      padding:10px 14px 10px 38px; /* å·¦ä¾§ç»™å›¾æ ‡ç•™ç©ºé—´ */
      border:1px solid #d8dee6; border-radius:10px; outline:none;
      background:
        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="%2388a" viewBox="0 0 16 16"><path d="M3 2a1 1 0 0 0-1 1v8.586a1 1 0 0 0 1.707.707L6.5 8.5l2.293 2.293a1 1 0 0 0 1.414 0L14 7v5a2 2 0 0 1-2 2H5.5L3 16V3a1 1 0 0 1 1-1h-1z"/></svg>')
          no-repeat 12px center #fff;
      transition: border-color .15s ease, box-shadow .15s ease, background-color .2s ease;
    }
    .cat-input:focus{
      border-color:#93c5fd;
      box-shadow:0 0 0 3px rgba(59,130,246,.25);
    }
    .cat-add{
      padding:10px 14px; border-radius:10px;
      font-weight:600;
    }

    /* æˆåŠŸ/å¤±è´¥çš„å°åŠ¨ç”» */
    @keyframes pulse {
      0%{ box-shadow:0 0 0 0 rgba(52,152,219,.35); }
      100%{ box-shadow:0 0 0 10px rgba(52,152,219,0); }
    }
    .cat-form.flash{ animation:pulse .6s ease-out; }
    @keyframes shake {
      10%,90%{ transform:translateX(-1px) }
      20%,80%{ transform:translateX(2px) }
      30%,50%,70%{ transform:translateX(-4px) }
      40%,60%{ transform:translateX(4px) }
    }
    .cat-input.error{ animation:shake .32s linear; border-color:#fca5a5; }

    /* è‡ªå®šä¹‰åˆ†ç±» chips åˆ—è¡¨å®¹å™¨ */
    .cat-list{ display:flex; flex-wrap:wrap; gap:10px; margin:8px 0 14px; color:#6b7280; }

    /* å•ä¸ª chipï¼šåœ†æ¶¦ + å¾®æµ®åŠ¨ + è½»è¾¹æ¡† */
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 12px; border-radius:999px;
      background:#eef2ff; border:1px solid #dbe4ff;
      transition: transform .12s ease, box-shadow .12s ease, background .2s ease;
    }
    .chip:hover{
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(0,0,0,.08);
      background:#e7f0ff;
    }

    /* chip å·¦è¾¹â€œåˆ†ç±»åæŒ‰é’®â€ */
    .chip .chip-goto{
      border:0; background:transparent; cursor:pointer; color:#1f3b7a; font-weight:600;
    }

    /* æ•°é‡å¾½ç« ï¼ˆæ˜¾ç¤ºè¯¥åˆ†ç±»ä¸‹æœ‰å¤šå°‘ä»»åŠ¡ï¼‰ */
    .chip .chip-badge{
      display:inline-grid; place-items:center;
      min-width:20px; height:20px; padding:0 6px;
      font-size:12px; font-weight:700; color:#1f2937;
      background:#fff; border:1px solid #e2e8f0; border-radius:999px;
    }

    /* å³ä¾§åˆ é™¤ Ã— å°åœ†ç‚¹æŒ‰é’® */
    .chip .chip-del{
      border:0; cursor:pointer; width:22px; height:22px; border-radius:50%;
      display:inline-grid; place-items:center;
      background:#f1f5f9; color:#ef4444; font-weight:700; line-height:1;
      transition: transform .12s ease, background .2s ease, color .2s ease;
    }
    .chip .chip-del:hover{ background:#fee2e2; color:#b91c1c; transform: translateY(-1px); }

  </style>

  </head>
  <body>
    <div class="container-panel">
      <h1>ğŸ“‹ åˆ†ç±»å¾…åŠäº‹é¡¹</h1>
      
      <!-- æ·»åŠ ä»»åŠ¡çš„åŒºåŸŸ -->
      <div class="row">
        <input type="text" id="taskInput" placeholder="è¾“å…¥æ–°çš„å¾…åŠäº‹é¡¹â€¦â€¦">

        <!-- æ–°å¢ï¼šåˆ†ç±»é€‰æ‹© -->
        <select id="categorySelect">
          <option value="å·¥ä½œ">å·¥ä½œ</option>
          <option value="å­¦ä¹ ">å­¦ä¹ </option>
          <option value="ç”Ÿæ´»">ç”Ÿæ´»</option>
          <option value="è´­ç‰©">è´­ç‰©</option>
          <option value="å…¶ä»–">å…¶ä»–</option>
        </select>

        <button id="addButton" class="btn">æ·»åŠ ä»»åŠ¡</button>
      </div>

      <!-- æ–°å¢ï¼šåˆ†ç±»ç­›é€‰æ ‡ç­¾ -->
      <div id="filters">
        <button data-filter="å…¨éƒ¨">å…¨éƒ¨</button>
        <button data-filter="å·¥ä½œ">å·¥ä½œ</button>
        <button data-filter="å­¦ä¹ ">å­¦ä¹ </button>
        <button data-filter="ç”Ÿæ´»">ç”Ÿæ´»</button>
        <button data-filter="è´­ç‰©">è´­ç‰©</button>
        <button data-filter="å…¶ä»–">å…¶ä»–</button>
      </div>

      <!-- è‡ªå®šä¹‰åˆ†ç±»ï¼šæ–°å¢è¡¨å• -->
      <div id="customCatForm" class="cat-form">
        <input type="text" id="newCategoryInput" class="cat-input" placeholder="è¾“å…¥æ–°åˆ†ç±»åç§°">
        <button id="addCategoryBtn" class="btn cat-add">æ·»åŠ åˆ†ç±»</button>
      </div>

      <!-- è‡ªå®šä¹‰åˆ†ç±»ï¼šå±•ç¤ºåŒºï¼ˆç¨åç”¨ JS å¡«å†…å®¹ï¼‰ -->
      <div id="customCats" class="cat-list">æš‚æ— è‡ªå®šä¹‰åˆ†ç±»</div>

      <div id="currentFilter">å½“å‰ç­›é€‰ï¼šå…¨éƒ¨</div>

      <!-- æ˜¾ç¤ºä»»åŠ¡çš„åŒºåŸŸ -->
      <ul id="taskList">
        <!-- å°†æ¥ä»»åŠ¡ä¼šå‡ºç°åœ¨è¿™é‡Œ -->
      </ul>

      <!-- ç»Ÿè®¡æ˜¾ç¤º -->
      <div id="stats">æ€»æ•°ï¼š0 ï½œ å·²å®Œæˆï¼š0</div>
    </div>

    <script>
      // â€”â€” åº”ç”¨çŠ¶æ€ï¼ˆå”¯ä¸€çœŸç›¸ï¼‰â€”â€”
      let tasks = []; // æ¯ä¸ªä»»åŠ¡ï¼š{ id: number, text: string, completed: boolean }
      const STORAGE_KEY = 'my_todos_v1';
      // æ–°å¢ï¼šå½“å‰ç­›é€‰ï¼ˆé»˜è®¤â€œå…¨éƒ¨â€ï¼‰
      let currentFilter = 'å…¨éƒ¨';
      let customCategories = [];
      const STORAGE_KEY_CATS = 'my_todos_cats_v1';
      const RESERVED = new Set(['å…¨éƒ¨','å·¥ä½œ','å­¦ä¹ ','ç”Ÿæ´»','è´­ç‰©','å…¶ä»–']);

      function highlightActiveFilter() {
        const buttons = document.querySelectorAll('#filters button[data-filter]');
        buttons.forEach(btn => {
          if (btn.dataset.filter === currentFilter) btn.classList.add('is-active');
          else btn.classList.remove('is-active');
        });
      }

      function getVisible() {
        return (currentFilter === 'å…¨éƒ¨')
          ? tasks
          : tasks.filter(t => t.category === currentFilter);
      }

      function computeStats(arr) {
        const total = arr.length;
        const done = arr.filter(t => t.completed).length;
        return { total, done };
      }

      function save() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
      }

      function updateStats() {
        const statsDiv = document.getElementById('stats');
        const total = tasks.length;
        const done = tasks.filter(t => t.completed).length;
        statsDiv.textContent = `æ€»æ•°ï¼š${total} ï½œ å·²å®Œæˆï¼š${done}`;
      }

      // ä»…æ›´æ–°è‡ªå®šä¹‰åˆ†ç±» chips ä¸Šçš„æ•°é‡å¾½ç« ï¼Œä¸é‡å»º DOM
      function updateCategoryBadges() {
        // æ‰¾åˆ°æ‰€æœ‰ chipï¼ˆæ¯ä¸ª chip é‡Œï¼š.chip-goto æ˜¯åç§°ï¼Œ.chip-badge æ˜¯æ•°å­—ï¼‰
        document.querySelectorAll('#customCats .chip').forEach(chip => {
          const nameEl = chip.querySelector('.chip-goto');
          const badgeEl = chip.querySelector('.chip-badge');
          if (!nameEl || !badgeEl) return;
          const cat = nameEl.textContent;
          // ç»Ÿè®¡è¯¥åˆ†ç±»ä¸‹ä»»åŠ¡æ€»æ•°ï¼ˆä¸åŒºåˆ†å®Œæˆä¸å¦ï¼‰
          const count = tasks.filter(t => t.category === cat).length;
          badgeEl.textContent = count;
        });
      }

      function deleteCustomCategory(cat) {
        if (!customCategories.includes(cat)) return;
        const ok = confirm(`ç¡®å®šåˆ é™¤åˆ†ç±»ã€Œ${cat}ã€å—ï¼Ÿ\nè¯¥åˆ†ç±»ä¸‹çš„ä»»åŠ¡å°†è‡ªåŠ¨ç§»åŠ¨åˆ°ã€Œå…¶ä»–ã€ã€‚`);
        if (!ok) return;

        // 1) ä»è‡ªå®šä¹‰åˆ†ç±»åˆ—è¡¨ç§»é™¤
        customCategories = customCategories.filter(c => c !== cat);
        saveCats();

        // 2) è¿ç§»ä»»åŠ¡ï¼šå‡¡æ˜¯è¿™ä¸ªåˆ†ç±»çš„ï¼Œæ”¹æˆâ€œå…¶ä»–â€
        let changed = false;
        tasks = tasks.map(t => {
          if (t.category === cat) {
            changed = true;
            return { ...t, category: 'å…¶ä»–' };
          }
          return t;
        });
        if (changed) save();

        // 3) å¦‚æœå½“å‰å°±åœ¨è¿™ä¸ªåˆ†ç±»çš„ç­›é€‰é‡Œï¼Œåˆ‡å›â€œå…¨éƒ¨â€
        if (currentFilter === cat) currentFilter = 'å…¨éƒ¨';

        // 4) ç»Ÿä¸€é‡æ¸²æŸ“
        renderFilters();
        render();
      }

      function renderFilters() {
        // 1) ç»™â€œæ·»åŠ ä»»åŠ¡â€çš„ä¸‹æ‹‰ select è¡¥ä¸Šè‡ªå®šä¹‰åˆ†ç±»
        const select = document.getElementById('categorySelect');
        const fixedValues = ['å·¥ä½œ','å­¦ä¹ ','ç”Ÿæ´»','è´­ç‰©','å…¶ä»–'];

        // å…ˆé‡å»ºå›ºå®šé¡¹
        select.innerHTML = '';
        fixedValues.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v;
          opt.textContent = v;
          select.appendChild(opt);
        });
        // å†è¿½åŠ è‡ªå®šä¹‰é¡¹
        customCategories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.textContent = cat;
          select.appendChild(opt);
        });

        // 2) è‡ªå®šä¹‰åˆ†ç±»â€œchipsâ€æ¸²æŸ“ï¼ˆåªæ¸²æŸ“ä¸€æ¬¡ï¼Œä½¿ç”¨ä½ å®šä¹‰å¥½çš„ .chip æ ·å¼ï¼‰
        const wrap = document.getElementById('customCats');
        wrap.innerHTML = '';

        if (customCategories.length === 0) {
          wrap.textContent = 'æš‚æ— è‡ªå®šä¹‰åˆ†ç±»';
          return;
        }

        customCategories.forEach(cat => {
          const chip = document.createElement('span');
          chip.className = 'chip';

          // åˆ†ç±»åæŒ‰é’®ï¼ˆç‚¹å‡»åˆ‡æ¢ç­›é€‰ï¼‰
          const go = document.createElement('button');
          go.className = 'chip-goto';
          go.textContent = cat;
          go.addEventListener('click', () => {
            currentFilter = cat;
            highlightActiveFilter?.();
            render();
          });

          // æ•°é‡å¾½ç« 
          const badge = document.createElement('span');
          badge.className = 'chip-badge';
          badge.textContent = tasks.filter(t => t.category === cat).length;

          // åˆ é™¤æŒ‰é’®
          const del = document.createElement('button');
          del.className = 'chip-del';
          del.textContent = 'Ã—';
          del.title = `åˆ é™¤åˆ†ç±»ã€Œ${cat}ã€`;
          del.addEventListener('click', () => deleteCustomCategory(cat));

          chip.appendChild(go);
          chip.appendChild(badge);
          chip.appendChild(del);
          wrap.appendChild(chip);
        });
      }
      
      function render() {
        list.innerHTML = '';

        // è®¡ç®—å¯è§åˆ—è¡¨
        const visible = getVisible();

        // ç©ºæ€
        if (visible.length === 0) {
          const li = document.createElement('li');
          li.innerHTML = '<div class="empty">æš‚æ— ä»»åŠ¡ï¼ˆæˆ–å½“å‰åˆ†ç±»ä¸‹æš‚æ— ä»»åŠ¡ï¼‰</div>';
          list.appendChild(li);
        } else {
          // æ¸²æŸ“å¯è§é¡¹
          visible.forEach(task => {
            const li = document.createElement('li');

            const check = document.createElement('input');
            check.type = 'checkbox';
            check.checked = task.completed;

            const span = document.createElement('span');
            span.className = 'task-text';
            span.textContent = `[${task.category}] ${task.text}`;
            if (task.completed) span.classList.add('completed');

            const del = document.createElement('button');
            del.textContent = 'åˆ é™¤';
            del.className = 'btn-del';

            check.addEventListener('change', () => {
              task.completed = check.checked;
              save();
              render(); // åªéœ€ render
            });

            del.addEventListener('click', () => {
              tasks = tasks.filter(t => t.id !== task.id);
              save();
              render(); // åªéœ€ render
            });

            li.appendChild(check);
            li.appendChild(span);
            li.appendChild(del);
            list.appendChild(li);
          });
        }

        // æ›´æ–°â€œå½“å‰ç­›é€‰â€æç¤º
        if (currentFilterDiv) {
          currentFilterDiv.textContent = `å½“å‰ç­›é€‰ï¼š${currentFilter}`;
        }

        // â€”â€” ç»Ÿä¸€æ›´æ–°ä¸¤ç§ç»Ÿè®¡ â€”â€” 
        const statsCurrentDiv = document.getElementById('statsCurrent');
        const { total: tc, done: dc } = computeStats(visible);
        if (statsCurrentDiv) {
          statsCurrentDiv.textContent = `å½“å‰åˆ†ç±»ï¼šæ€»æ•°ï¼š${tc} ï½œ å·²å®Œæˆï¼š${dc}`;
        }

        const statsDiv = document.getElementById('stats');
        const { total, done } = computeStats(tasks);
        if (statsDiv) {
          statsDiv.textContent = `æ€»æ•°ï¼š${total} ï½œ å·²å®Œæˆï¼š${done}`;
        }

        updateCategoryBadges();
      }
    
      // è·å–é¡µé¢å…ƒç´ 
      const input = document.getElementById('taskInput'); // è¾“å…¥æ¡†
      const button = document.getElementById('addButton'); // æŒ‰é’®
      const list = document.getElementById('taskList'); // åˆ—è¡¨
      const categorySelect = document.getElementById('categorySelect');
      const currentFilterDiv = document.getElementById('currentFilter');
      const filtersDiv = document.getElementById('filters');


      // ç»™æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
      button.addEventListener('click', function () {
        const text = input.value.trim();
        if (!text) { alert('è¯·è¾“å…¥å†…å®¹'); return; }

        // å¾€â€œçŠ¶æ€â€é‡ŒåŠ ä¸€æ¡
        tasks.push({
          id: Date.now(),
          text,
          completed: false,
          category: categorySelect.value   // æ–°å¢å­—æ®µ
        });

        // ä¿å­˜ â†’ æ¸²æŸ“
        save();
        render();

        input.value = '';
        input.focus();
      });

      const newCategoryInput = document.getElementById('newCategoryInput');
      const addCategoryBtn = document.getElementById('addCategoryBtn');

      function saveCats() {
        localStorage.setItem(STORAGE_KEY_CATS, JSON.stringify(customCategories));
      }

      addCategoryBtn.addEventListener('click', () => {
        const name = (newCategoryInput.value || '').trim();
        if (!name) {
          newCategoryInput.classList.add('error');
          setTimeout(() => newCategoryInput.classList.remove('error'), 350);
          alert('è¯·è¾“å…¥åˆ†ç±»åç§°');
          return; 
        }
        
        if (RESERVED.has(name)) {
          newCategoryInput.classList.add('error');
          setTimeout(() => newCategoryInput.classList.remove('error'), 350);
          alert('è¿™æ˜¯ä¿ç•™åˆ†ç±»ï¼Œä¸èƒ½é‡å¤æ·»åŠ ');
          return; 
        }

        if (customCategories.includes(name)) {
          newCategoryInput.classList.add('error');
          setTimeout(() => newCategoryInput.classList.remove('error'), 350);
          alert('è¯¥åˆ†ç±»å·²å­˜åœ¨'); 
          return; 
        }

        customCategories.push(name);
        saveCats();
        renderFilters();  // æ›´æ–°ä¸‹æ‹‰å’Œå±•ç¤ºåŒº

        const form = document.getElementById('customCatForm');
        form.classList.remove('flash'); // å…ˆç§»é™¤é˜²æ­¢è¿ç‚¹æ— æ•ˆ
        void form.offsetWidth;          // è§¦å‘é‡ç»˜ä»¥é‡å¯åŠ¨ç”»
        form.classList.add('flash');

        newCategoryInput.value = '';
      });

      // å›è½¦æ·»åŠ 
      newCategoryInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') addCategoryBtn.click();
      });

      // æŒ‰ Enter ç›´æ¥æ·»åŠ ä»»åŠ¡
      input.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') {
              button.click(); // è§¦å‘â€œæ·»åŠ ä»»åŠ¡â€å’Œåç»­æ¸²æŸ“/ç»Ÿè®¡
          }
      });

      document.addEventListener('DOMContentLoaded', () => {
        // 1) å…ˆä» localStorage è¯»å–
        const raw = localStorage.getItem(STORAGE_KEY);
        tasks = raw ? JSON.parse(raw) : [];

        // è¯»å–è‡ªå®šä¹‰åˆ†ç±»
        try {
          const rawCats = localStorage.getItem(STORAGE_KEY_CATS);
          customCategories = rawCats ? JSON.parse(rawCats) : [];
        } catch {
          customCategories = [];
          localStorage.removeItem(STORAGE_KEY_CATS);
        }
        
        renderFilters();

        // 2) æ¸²æŸ“ + ç»Ÿè®¡
        render();
        // é¡µé¢åŠ è½½å®Œä¹Ÿåˆå§‹åŒ–ä¸€æ¬¡é«˜äº®
        highlightActiveFilter();
      });

      // äº‹ä»¶å§”æ‰˜ï¼šfilters å®¹å™¨é‡Œç‚¹åˆ°å“ªä¸ªæŒ‰é’®éƒ½èƒ½æ‹¿åˆ° data-filter
      filtersDiv.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-filter]');
        if (!btn) return;
        currentFilter = btn.dataset.filter;
        highlightActiveFilter(); // æ–°å¢
        render();
      });

    </script>
  </body>
</html>
