<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8">
    <title>我的第一个待办页面</title>
  </head>
  <body>
    <h1>📋 分类待办事项</h1>
    
    <!-- 添加任务的区域 -->
    <div>
      <input type="text" id="taskInput" placeholder="输入新的待办事项……">

      <!-- 新增：分类选择 -->
      <select id="categorySelect">
        <option value="工作">工作</option>
        <option value="学习">学习</option>
        <option value="生活">生活</option>
        <option value="购物">购物</option>
        <option value="其他">其他</option>
      </select>

      <button id="addButton">添加任务</button>
    </div>

    <!-- 新增：分类筛选标签 -->
    <div id="filters">
      <button data-filter="全部">全部</button>
      <button data-filter="工作">工作</button>
      <button data-filter="学习">学习</button>
      <button data-filter="生活">生活</button>
      <button data-filter="购物">购物</button>
      <button data-filter="其他">其他</button>
    </div>
    <div id="currentFilter">当前筛选：全部</div>

    <!-- 显示任务的区域 -->
    <ul id="taskList">
      <!-- 将来任务会出现在这里 -->
    </ul>

    <!-- 统计显示 -->
    <div id="stats">总数：0 ｜ 已完成：0</div>

    <script>
      // —— 应用状态（唯一真相）——
      let tasks = []; // 每个任务：{ id: number, text: string, completed: boolean }
      const STORAGE_KEY = 'my_todos_v1';
      // 新增：当前筛选（默认“全部”）
      let currentFilter = '全部';

      function getVisible() {
        return (currentFilter === '全部')
          ? tasks
          : tasks.filter(t => t.category === currentFilter);
      }

      function computeStats(arr) {
        const total = arr.length;
        const done = arr.filter(t => t.completed).length;
        return { total, done };
      }

      function save() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
      }

      function updateStats() {
        const statsDiv = document.getElementById('stats');
        const total = tasks.length;
        const done = tasks.filter(t => t.completed).length;
        statsDiv.textContent = `总数：${total} ｜ 已完成：${done}`;
      }
      
      function render() {
        list.innerHTML = '';

        // 计算可见列表
        const visible = getVisible();

        // 空态
        if (visible.length === 0) {
          const li = document.createElement('li');
          li.textContent = '暂无任务（或当前分类下暂无任务）';
          li.style.color = '#777';
          list.appendChild(li);
        } else {
          // 渲染可见项
          visible.forEach(task => {
            const li = document.createElement('li');

            const check = document.createElement('input');
            check.type = 'checkbox';
            check.checked = task.completed;

            const span = document.createElement('span');
            span.textContent = `[${task.category}] ${task.text}`;
            if (task.completed) {
              span.style.textDecoration = 'line-through';
              span.style.color = '#777';
            }

            const del = document.createElement('button');
            del.textContent = '删除';

            check.addEventListener('change', () => {
              task.completed = check.checked;
              save();
              render(); // 只需 render
            });

            del.addEventListener('click', () => {
              tasks = tasks.filter(t => t.id !== task.id);
              save();
              render(); // 只需 render
            });

            li.appendChild(check);
            li.appendChild(span);
            li.appendChild(del);
            list.appendChild(li);
          });
        }

        // 更新“当前筛选”提示
        if (currentFilterDiv) {
          currentFilterDiv.textContent = `当前筛选：${currentFilter}`;
        }

        // —— 统一更新两种统计 —— 
        const statsCurrentDiv = document.getElementById('statsCurrent');
        const { total: tc, done: dc } = computeStats(visible);
        if (statsCurrentDiv) {
          statsCurrentDiv.textContent = `当前分类：总数：${tc} ｜ 已完成：${dc}`;
        }

        const statsDiv = document.getElementById('stats');
        const { total, done } = computeStats(tasks);
        if (statsDiv) {
          statsDiv.textContent = `总数：${total} ｜ 已完成：${done}`;
        }
      }
    
      // 获取页面元素
      const input = document.getElementById('taskInput'); // 输入框
      const button = document.getElementById('addButton'); // 按钮
      const list = document.getElementById('taskList'); // 列表
      const categorySelect = document.getElementById('categorySelect');
      const currentFilterDiv = document.getElementById('currentFilter');
      const filtersDiv = document.getElementById('filters');


      // 给按钮绑定点击事件
      button.addEventListener('click', function () {
        const text = input.value.trim();
        if (!text) { alert('请输入内容'); return; }

        // 往“状态”里加一条
        tasks.push({
          id: Date.now(),
          text,
          completed: false,
          category: categorySelect.value   // 新增字段
        });

        // 保存 → 渲染
        save();
        render();

        input.value = '';
        input.focus();
      });

      // 按 Enter 直接添加任务
      input.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') {
              button.click(); // 触发“添加任务”和后续渲染/统计
          }
      });

      document.addEventListener('DOMContentLoaded', () => {
        // 1) 先从 localStorage 读取
        const raw = localStorage.getItem(STORAGE_KEY);
        tasks = raw ? JSON.parse(raw) : [];

        // 2) 渲染 + 统计
        render();
      });

      // 事件委托：filters 容器里点到哪个按钮都能拿到 data-filter
      filtersDiv.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-filter]');
        if (!btn) return;
        currentFilter = btn.dataset.filter; // 读取 data-filter 的值
        render();
      });

    </script>
  </body>
</html>
